{"version":3,"file":"contensis-react-base.js","sources":["../src/server/util/displayStartupConfiguration.js","../src/server/util/fetchMyIp.js","../src/server/core/localDns.js","../src/server/core/reverseProxies.js","../src/server/cacheDuration.schema.js","../src/server/util/staticPaths.js","../src/server/middleware/bundleManipulation.js","../src/server/core/staticAssets.js","../node_modules/fromentries/index.js","../src/server/util/types.js","../src/server/util/handleResponse.js","../src/server/util/cacheHashing.js","../src/server/core/webApp.js","../src/server/internalServer.js"],"sourcesContent":["const servers = SERVERS; /* global SERVERS */\r\nconst projects = PROJECTS; /* global PROJECTS */\r\n\r\nconst DisplayStartupConfiguration = config => {\r\n  /* eslint-disable no-console */\r\n  console.log();\r\n  console.log(\r\n    `Configured servers:\r\n`,\r\n    JSON.stringify(servers, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    `Configured projects:\r\n`,\r\n    JSON.stringify(projects, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    'Reverse proxy paths: ',\r\n    JSON.stringify(config.reverseProxyPaths, null, 2)\r\n  );\r\n  console.log();\r\n\r\n  /* eslint-enable no-console */\r\n};\r\n\r\nexport default DisplayStartupConfiguration;\r\n","const fetchMyIp = async (env, configureLocalEndpoint) => {\r\n  /* eslint-disable no-console */\r\n  try {\r\n    const response = await fetch('https://api.ipify.org?format=json', {\r\n      method: 'GET',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n    });\r\n\r\n    const ipJson = await response.json();\r\n    console.log(`Current public ip -> ${JSON.stringify(ipJson)}`);\r\n    if (ipJson.ip.startsWith('185.18.13')) {\r\n      console.log(\r\n        `Using local endpoint for ${env.alias} -> ${env.internalVip}`\r\n      );\r\n      configureLocalEndpoint();\r\n    } else {\r\n      console.log(`Outside Zengenti network, use real DNS.`);\r\n    }\r\n  } catch (error) {\r\n    console.log(\r\n      `Could not work out where I am so defaulting to local DNS, as I am probably running as a container this is what matters most. Not developers at home or tests :( Sorry. error: ${error}`\r\n    );\r\n    configureLocalEndpoint();\r\n  }\r\n\r\n  /* eslint-enable no-console */\r\n};\r\n\r\nexport default fetchMyIp;\r\n","import evilDns from 'evil-dns';\r\nimport fetchMyIp from '../util/fetchMyIp';\r\n\r\nconst servers = SERVERS; /* global SERVERS */\r\nconst apiConfig = DELIVERY_API_CONFIG; /* global DELIVERY_API_CONFIG */\r\n\r\nconst localDns = async () => {\r\n  const disableDnsChanges = false;\r\n\r\n  const configureLocalEndpoint = () => {\r\n    if (!disableDnsChanges) {\r\n      evilDns.add(`*${servers.alias}.cloud.contensis.com`, servers.internalVip);\r\n\r\n      if (apiConfig.internalIp)\r\n        evilDns.add(apiConfig.rootUrl, apiConfig.internalIp);\r\n    }\r\n  };\r\n\r\n  // Break api.ipify to test\r\n  // evilDns.add('api.ipify.org', '8.8.8.8');\r\n  await fetchMyIp(servers, configureLocalEndpoint);\r\n};\r\n\r\nexport default localDns;\r\n","import httpProxy from 'http-proxy';\r\n\r\nconst servers = SERVERS; /* global SERVERS */\r\nexport const apiProxy = httpProxy.createProxyServer();\r\n\r\nconst reverseProxies = (app, reverseProxyPaths) => {\r\n  deliveryApiProxy(apiProxy, app);\r\n\r\n  app.all(reverseProxyPaths, (req, res) => {\r\n    const target =\r\n      req.hostname.indexOf('preview-') ||\r\n      req.hostname.indexOf('preview.') ||\r\n      req.hostname === 'localhost'\r\n        ? servers.previewIis || servers.iis\r\n        : servers.iis;\r\n\r\n    apiProxy.web(req, res, { target, changeOrigin: true });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy Request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nconst deliveryApiProxy = (apiProxy, app) => {\r\n  // This is just here to stop cors requests on localhost. In Production this is mapped using varnish.\r\n  app.all(['/api/delivery/*', '/api/image/*'], (req, res) => {\r\n    /* eslint-disable no-console */\r\n    const target = servers.cms;\r\n    console.log(`Proxying api request to ${servers.alias}`);\r\n    apiProxy.web(req, res, {\r\n      target,\r\n      changeOrigin: true,\r\n    });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nexport default reverseProxies;\r\n","export const CacheDuration = {\r\n  200: '3600',\r\n  404: '5',\r\n  static: '31536000', // Believe it or not these two max ages are the same in runtime\r\n  expressStatic: '31557600h', // Believe it or not these two max ages are the same in runtime\r\n};\r\n\r\nexport const getCacheDuration = (status = 200) => {\r\n  if (status > 400) return CacheDuration[404];\r\n  return CacheDuration[200];\r\n};\r\n","export const replaceStaticPath = (string, staticFolderPath = 'static') =>\r\n  string.replace(/static\\//g, `${staticFolderPath}/`);\r\n","import fs from 'fs';\r\nimport path from 'path';\r\nimport { replaceStaticPath } from '../util/staticPaths';\r\nimport { resolve } from 'app-root-path';\r\n\r\nexport const bundleManipulationMiddleware = (\r\n  staticRoutePath,\r\n  { maxage } = {}\r\n) => (req, res, next) => {\r\n  const filename = path.basename(req.path);\r\n  const modernBundle = filename.endsWith('.mjs');\r\n  const legacyBundle = filename.endsWith('.js');\r\n  if ((legacyBundle || modernBundle) && filename.startsWith('runtime.')) {\r\n    const jsRuntimeLocation = resolve(\r\n      `/dist/static/${modernBundle ? 'modern/js' : 'legacy/js'}/${filename}`\r\n    );\r\n    try {\r\n      const jsRuntimeBundle = fs.readFileSync(jsRuntimeLocation, 'utf8');\r\n      const modifiedBundle = replaceStaticPath(\r\n        jsRuntimeBundle,\r\n        staticRoutePath\r\n      );\r\n      if (maxage) res.set('Cache-Control', `public, max-age=${maxage}`);\r\n      res.type('.js').send(modifiedBundle);\r\n      return;\r\n    } catch (readError) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `Unable to find js runtime bundle at '${jsRuntimeLocation}'`,\r\n        readError\r\n      );\r\n      next();\r\n    }\r\n  } else {\r\n    next();\r\n  }\r\n};\r\n","import express from 'express';\r\nimport { CacheDuration } from '../cacheDuration.schema';\r\nimport { bundleManipulationMiddleware } from '../middleware/bundleManipulation';\r\n\r\n// Serving static assets\r\nconst staticAssets = (\r\n  app,\r\n  { staticRoutePath, staticRoutePaths = [], staticFolderPath = 'static' }\r\n) => {\r\n  app.use(\r\n    [\r\n      `/${staticRoutePath}`,\r\n      ...staticRoutePaths.map(p => `/${p}`),\r\n      `/${staticFolderPath}`,\r\n    ],\r\n    bundleManipulationMiddleware(staticRoutePath, {\r\n      // these maxage values are different in config but the same in runtime,\r\n      // this one is the true value in seconds\r\n      maxage: CacheDuration.static,\r\n    }),\r\n    express.static(`dist/${staticFolderPath}`, {\r\n      // these maxage values are different in config but the same in runtime,\r\n      // this one is somehow converted and should end up being the same as CacheDuration.static\r\n      maxage: CacheDuration.expressStatic,\r\n    })\r\n  );\r\n};\r\n\r\nexport default staticAssets;\r\n","/*! fromentries. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */\nmodule.exports = function fromEntries (iterable) {\n  return [...iterable].reduce((obj, [key, val]) => {\n    obj[key] = val\n    return obj\n  }, {})\n}\n","export const ResponseMethod = {\r\n  send: 'send',\r\n  json: 'json',\r\n  end: 'end',\r\n};\r\n","/* eslint-disable no-console */\r\nimport { ResponseMethod } from './types';\r\n\r\n/**\r\n * Web Application Response handler, sends a prepared express js response\r\n * with the supplied content sending in the specified manner\r\n * @param {response} request express js request object\r\n * @param {response} response express js response object\r\n * @param {string | object} content the content to send in the response body\r\n * @param {function} send the response function to call e.g res.send() res.json() res.end()\r\n */\r\nconst handleResponse = (\r\n  request,\r\n  response,\r\n  content,\r\n  send = ResponseMethod.send\r\n) => {\r\n  // console.log('---', response.statusCode, '---');\r\n  response[send](content);\r\n};\r\n\r\nexport default handleResponse;\r\n","export const hashKeys = keys => {\r\n  const XXHash = require('xxhashjs');\r\n  const returnKeys = [];\r\n  keys.forEach(cacheKey => {\r\n    const inputBuffer = Buffer.from(cacheKey.toLowerCase(), 'utf-8');\r\n\r\n    const hashed = XXHash.h32(inputBuffer, 0x0).toString(16);\r\n    const reversedhex = hashed\r\n      .match(/[a-fA-F0-9]{2}/g)\r\n      .reverse()\r\n      .join('');\r\n\r\n    const outputBuffer = Buffer.from(reversedhex, 'hex');\r\n\r\n    returnKeys.push(outputBuffer.toString('base64').substring(0, 6));\r\n  });\r\n  return returnKeys;\r\n};\r\n","import fs from 'fs';\r\nimport React from 'react';\r\nimport { StaticRouter } from 'react-router-dom';\r\nimport { Provider as ReduxProvider } from 'react-redux';\r\nimport Loadable from 'react-loadable';\r\nimport { renderToString } from 'react-dom/server';\r\nimport { getBundles } from 'react-loadable/webpack';\r\nimport { ServerStyleSheet } from 'styled-components';\r\nimport Helmet from 'react-helmet';\r\nimport serialize from 'serialize-javascript';\r\nimport minifyCssString from 'minify-css-string';\r\nimport { fromJS } from 'immutable';\r\nimport fromEntries from 'fromentries';\r\n\r\nimport { history } from '~/core/redux/history';\r\n\r\nimport handleResponse from '../util/handleResponse';\r\nimport { hashKeys } from '../util/cacheHashing';\r\n\r\nimport pickProject from '~/core/util/pickProject';\r\nimport { GetDeliveryApiStatusFromHostname } from '~/core/util/ContensisDeliveryApi';\r\n\r\nimport { setCurrentProject } from '~/core/redux/actions/routing';\r\nimport { setVersion, setVersionStatus } from '~/core/redux/actions/version';\r\n\r\nimport {\r\n  selectCurrentProject,\r\n  selectCurrentTreeID,\r\n  selectEntryDepends,\r\n  selectNodeDepends,\r\n  selectRouteEntry,\r\n} from '~/core/redux/selectors/routing';\r\n\r\nimport createStore from '~/core/redux/store';\r\nimport rootSaga from '~/core/redux/sagas/index.js';\r\nimport { matchRoutes } from 'react-router-config';\r\nimport mapJson from 'jsonpath-mapper';\r\nimport { replaceStaticPath } from '../util/staticPaths';\r\nimport { getCacheDuration } from '../cacheDuration.schema';\r\n\r\nconst addStandardHeaders = (state, response, packagejson, groups) => {\r\n  if (state) {\r\n    try {\r\n      console.info('About to add header');\r\n      let entryDepends = selectEntryDepends(state);\r\n      entryDepends = Array.from(entryDepends || {});\r\n      console.info(`entryDepends count: ${entryDepends.length}`);\r\n\r\n      let nodeDepends = selectNodeDepends(state).toJS();\r\n      let currentTreeId = selectCurrentTreeID(state);\r\n      let nodeDependsKeys = nodeDepends.map(nodeKey => {\r\n        return `${currentTreeId}_${nodeKey}`;\r\n      });\r\n      const allDepends = [...entryDepends, ...nodeDependsKeys];\r\n      const allDependsHashed = hashKeys(allDepends);\r\n\r\n      const surrogateKeyHeader =\r\n        packagejson.name == 'os-main'\r\n          ? ` ${packagejson.name}-app ${allDependsHashed.join(\r\n              ' '\r\n            )} ${allDepends.join(' ')}`\r\n          : ` ${packagejson.name}-app ${allDependsHashed.join(' ')}`;\r\n\r\n      response.header('surrogate-key', surrogateKeyHeader);\r\n\r\n      console.info(`depends hashed: ${allDependsHashed.join(' ')}`);\r\n      console.info(`depends hashed: ${allDepends.join(' ')}`);\r\n\r\n      addVarnishAuthenticationHeaders(state, response, groups);\r\n\r\n      response.setHeader(\r\n        'Surrogate-Control',\r\n        `max-age=${getCacheDuration(response.statusCode)}`\r\n      );\r\n    } catch (e) {\r\n      console.info('Error Adding headers', e.message);\r\n    }\r\n  }\r\n};\r\n\r\nconst addVarnishAuthenticationHeaders = (state, response, groups = {}) => {\r\n  if (state) {\r\n    try {\r\n      const stateEntry = selectRouteEntry(state);\r\n      const project = selectCurrentProject(state);\r\n      const { globalGroups, allowedGroups } = groups;\r\n      // console.info(globalGroups, allowedGroups);\r\n      let allGroups = Array.from((globalGroups && globalGroups[project]) || {});\r\n      if (\r\n        stateEntry &&\r\n        stateEntry.getIn(['authentication', 'isLoginRequired']) &&\r\n        allowedGroups &&\r\n        allowedGroups[project]\r\n      ) {\r\n        allGroups = [...allGroups, ...allowedGroups[project]];\r\n      }\r\n      response.header('x-contensis-viewer-groups', allGroups.join('|'));\r\n    } catch (e) {\r\n      console.info('Error adding authentication header', e);\r\n    }\r\n  }\r\n};\r\n\r\nconst readFileSync = path => fs.readFileSync(path, 'utf8');\r\n\r\nconst loadableBundleData = ({ stats, templates }, staticRoutePath, build) => {\r\n  const bundle = {};\r\n  try {\r\n    bundle.stats = JSON.parse(\r\n      readFileSync(stats.replace('/target', build ? `/${build}` : ''))\r\n    );\r\n  } catch (ex) {\r\n    //console.info(ex);\r\n    bundle.stats = null;\r\n  }\r\n  try {\r\n    bundle.templates = {\r\n      templateHTML: replaceStaticPath(\r\n        readFileSync(\r\n          templates.html.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n      templateHTMLStatic: replaceStaticPath(\r\n        readFileSync(\r\n          templates.static.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n      templateHTMLFragment: replaceStaticPath(\r\n        readFileSync(\r\n          templates.fragment.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n    };\r\n  } catch (ex) {\r\n    //console.info(ex);\r\n    bundle.templates = null;\r\n  }\r\n  return bundle;\r\n};\r\n\r\nconst webApp = (app, ReactApp, config) => {\r\n  const {\r\n    routes,\r\n    withReducers,\r\n    withSagas,\r\n    withEvents,\r\n    packagejson,\r\n    staticFolderPath = 'static',\r\n    startupScriptFilename,\r\n    differentialBundles,\r\n    allowedGroups,\r\n    globalGroups,\r\n    disableSsrRedux,\r\n    handleResponses,\r\n  } = config;\r\n  const staticRoutePath = config.staticRoutePath || staticFolderPath;\r\n\r\n  const bundleData = {\r\n    default: loadableBundleData(config, staticRoutePath),\r\n    legacy: loadableBundleData(config, staticRoutePath, 'legacy'),\r\n    modern: loadableBundleData(config, staticRoutePath, 'modern'),\r\n  };\r\n  if (!bundleData.default || bundleData.default === {})\r\n    bundleData.default = bundleData.legacy || bundleData.modern;\r\n\r\n  const responseHandler =\r\n    typeof handleResponses === 'function' ? handleResponses : handleResponse;\r\n\r\n  const versionInfo = JSON.parse(\r\n    fs.readFileSync(`dist/${staticFolderPath}/version.json`, 'utf8')\r\n  );\r\n\r\n  app.get('/*', (request, response) => {\r\n    const { url } = request;\r\n\r\n    const matchedStaticRoute = () =>\r\n      matchRoutes(routes.StaticRoutes, request.path);\r\n    const isStaticRoute = () => matchedStaticRoute().length > 0;\r\n    const staticRoute = isStaticRoute() && matchedStaticRoute()[0];\r\n\r\n    // Allow certain routes to avoid SSR\r\n    const onlyDynamic = staticRoute && staticRoute.route.ssr === false;\r\n\r\n    const normaliseQs = q => (q && q.toLowerCase() === 'true' ? true : false);\r\n\r\n    // Determine functional params from QueryString and set access methods\r\n    const accessMethod = mapJson(request.query, {\r\n      DYNAMIC: ({ dynamic }) => normaliseQs(dynamic) || onlyDynamic,\r\n      REDUX: ({ redux }) => normaliseQs(redux),\r\n      FRAGMENT: ({ fragment }) => normaliseQs(fragment),\r\n      STATIC: ({ static: value }) => normaliseQs(value),\r\n    });\r\n\r\n    const context = {};\r\n    // Track the current statusCode via the response object\r\n    response.status(200);\r\n\r\n    // Create a store (with a memory history) from our current url\r\n    const store = createStore(\r\n      withReducers,\r\n      fromJS({}),\r\n      history({\r\n        initialEntries: [url],\r\n      })\r\n    );\r\n\r\n    // dispatch any global and non-saga related actions before calling our JSX\r\n    const versionStatusFromHostname = GetDeliveryApiStatusFromHostname(\r\n      request.hostname\r\n    );\r\n\r\n    console.info(\r\n      `Request for ${request.path} hostname: ${request.hostname} versionStatus: ${versionStatusFromHostname}`\r\n    );\r\n\r\n    store.dispatch(\r\n      setVersionStatus(request.query.versionStatus || versionStatusFromHostname)\r\n    );\r\n    store.dispatch(setVersion(versionInfo.commitRef, versionInfo.buildNo));\r\n\r\n    const project = pickProject(request.hostname, request.query);\r\n\r\n    const groups = allowedGroups && allowedGroups[project];\r\n    store.dispatch(setCurrentProject(project, groups));\r\n\r\n    const modules = [];\r\n\r\n    const jsx = (\r\n      <Loadable.Capture report={moduleName => modules.push(moduleName)}>\r\n        <ReduxProvider store={store}>\r\n          <StaticRouter context={context} location={url}>\r\n            <ReactApp routes={routes} withEvents={withEvents} />\r\n          </StaticRouter>\r\n        </ReduxProvider>\r\n      </Loadable.Capture>\r\n    );\r\n\r\n    const buildBundleTags = bundles => {\r\n      // Take the bundles returned from Loadable.Capture\r\n      const bundleTags = bundles\r\n        .map(bundle => {\r\n          if (bundle.publicPath.includes('/modern/'))\r\n            return differentialBundles\r\n              ? `<script type=\"module\" src=\"${replaceStaticPath(\r\n                  bundle.publicPath,\r\n                  staticRoutePath\r\n                )}\"></script>`\r\n              : null;\r\n          return `<script nomodule src=\"${replaceStaticPath(\r\n            bundle.publicPath,\r\n            staticRoutePath\r\n          )}\"></script>`;\r\n        })\r\n        .filter(f => f);\r\n\r\n      // Add the static startup script to the bundleTags\r\n      startupScriptFilename &&\r\n        bundleTags.push(\r\n          `<script src=\"/${staticRoutePath}/${startupScriptFilename}\"></script>`\r\n        );\r\n\r\n      return bundleTags;\r\n    };\r\n\r\n    const templates =\r\n      bundleData.default.templates || bundleData.legacy.templates;\r\n\r\n    const stats =\r\n      bundleData.modern.stats && bundleData.legacy.stats\r\n        ? fromEntries(\r\n            Object.entries(bundleData.modern.stats).map(([lib, paths]) => [\r\n              lib,\r\n              bundleData.legacy.stats[lib]\r\n                ? [...paths, ...bundleData.legacy.stats[lib]]\r\n                : paths,\r\n            ])\r\n          )\r\n        : bundleData.default.stats;\r\n\r\n    const {\r\n      templateHTML,\r\n      templateHTMLFragment,\r\n      templateHTMLStatic,\r\n    } = templates;\r\n\r\n    // Serve a blank HTML page with client scripts to load the app in the browser\r\n    if (accessMethod.DYNAMIC) {\r\n      // Dynamic doesn't need sagas\r\n      renderToString(jsx);\r\n\r\n      // Dynamic page render has only the necessary bundles to start up the app\r\n      // and does not include any react-loadable code-split bundles\r\n      const loadableBundles = getBundles(stats, modules);\r\n      const bundleTags = buildBundleTags(loadableBundles).join('');\r\n\r\n      const isDynamicHint = `<script>window.isDynamic = true;</script>`;\r\n\r\n      const responseHtmlDynamic = templateHTML\r\n        .replace('{{TITLE}}', '')\r\n        .replace('{{SEO_CRITICAL_METADATA}}', '')\r\n        .replace('{{CRITICAL_CSS}}', '')\r\n        .replace('{{APP}}', '')\r\n        .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n        .replace('{{REDUX_DATA}}', isDynamicHint);\r\n      // Dynamic pages always return a 200 so we can run\r\n      // the app and serve up all errors inside the client\r\n      response.setHeader(\r\n        'Surrogate-Control',\r\n        `max-age=${getCacheDuration(200)}`\r\n      );\r\n      responseHandler(request, response, responseHtmlDynamic);\r\n    }\r\n\r\n    // Render the JSX server side and send response as per access method options\r\n    if (!accessMethod.DYNAMIC) {\r\n      store\r\n        .runSaga(rootSaga(withSagas))\r\n        .toPromise()\r\n        .then(() => {\r\n          const sheet = new ServerStyleSheet();\r\n\r\n          const html = renderToString(sheet.collectStyles(jsx));\r\n\r\n          const helmet = Helmet.renderStatic();\r\n          Helmet.rewind();\r\n          const htmlAttributes = helmet.htmlAttributes.toString();\r\n          let title = helmet.title.toString();\r\n          const metadata = helmet.meta.toString();\r\n\r\n          if (context.url) {\r\n            return response.redirect(302, context.url);\r\n          }\r\n\r\n          const reduxState = store.getState();\r\n\r\n          const styleTags = sheet.getStyleTags();\r\n\r\n          // After running rootSaga there should be an additional react-loadable\r\n          // code-split bundle for a page component as well as core app bundles\r\n          const loadableBundles = getBundles(stats, modules);\r\n          const bundleTags = buildBundleTags(loadableBundles).join('');\r\n\r\n          let serialisedReduxData = '';\r\n          if (context.status !== 404) {\r\n            // For a request that returns a redux state object as a response\r\n            if (accessMethod.REDUX) {\r\n              serialisedReduxData = serialize(reduxState);\r\n              addStandardHeaders(reduxState, response, packagejson, {\r\n                allowedGroups,\r\n                globalGroups,\r\n              });\r\n              responseHandler(request, response, serialisedReduxData, 'json');\r\n              return true;\r\n            }\r\n            if (!disableSsrRedux) {\r\n              serialisedReduxData = serialize(reduxState);\r\n              serialisedReduxData = `<script>window.REDUX_DATA = ${serialisedReduxData}</script>`;\r\n            }\r\n          }\r\n          if (context.status > 400) {\r\n            accessMethod.STATIC = true;\r\n          }\r\n\r\n          // Responses\r\n          let responseHTML = '';\r\n\r\n          if (context.status === 404)\r\n            title = '<title>404 page not found</title>';\r\n\r\n          // Static page served as a fragment\r\n          if (accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            responseHTML = minifyCssString(styleTags) + html;\r\n          }\r\n\r\n          // Page fragment served with client scripts and redux data that hydrate the app client side\r\n          if (accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTMLFragment\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n\r\n          // Full HTML page served statically\r\n          if (!accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            responseHTML = templateHTMLStatic\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', '');\r\n          }\r\n\r\n          // Full HTML page served with client scripts and redux data that hydrate the app client side\r\n          if (!accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTML\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', styleTags)\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n\r\n          // Set response.status from React StaticRouter\r\n          if (typeof context.status === 'number')\r\n            response.status(context.status);\r\n\r\n          addStandardHeaders(reduxState, response, packagejson, {\r\n            allowedGroups,\r\n            globalGroups,\r\n          });\r\n          try {\r\n            // If react-helmet htmlAttributes are being used,\r\n            // replace the html tag with those attributes sepcified\r\n            // e.g. (lang, dir etc.)\r\n            if (htmlAttributes) {\r\n              responseHTML = responseHTML.replace(\r\n                /<html?.+?>/,\r\n                `<html ${htmlAttributes}>`\r\n              );\r\n            }\r\n            responseHandler(request, response, responseHTML);\r\n          } catch (err) {\r\n            console.info(err.message);\r\n          }\r\n        })\r\n        .catch(err => {\r\n          // Handle any error that occurred in any of the previous\r\n          // promises in the chain.\r\n          console.info(err);\r\n          response.status(500);\r\n          responseHandler(\r\n            request,\r\n            response,\r\n            `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\r\n          );\r\n        });\r\n      renderToString(jsx);\r\n\r\n      store.close();\r\n    }\r\n  });\r\n};\r\n\r\nexport default webApp;\r\n","import 'isomorphic-fetch';\r\nimport express from 'express';\r\nimport Loadable from 'react-loadable';\r\n\r\nimport DisplayStartupConfiguration from './util/displayStartupConfiguration';\r\nimport ConfigureLocalDNS from './core/localDns';\r\nimport ConfigureReverseProxies, { apiProxy } from './core/reverseProxies';\r\nimport ServeStaticAssets from './core/staticAssets';\r\nimport ConfigureWebApp from './core/webApp';\r\n\r\nconst app = express();\r\n\r\nconst start = (ReactApp, config, ServerFeatures) => {\r\n  app.disable('x-powered-by');\r\n\r\n  // Output some information about the used build/startup configuration\r\n  DisplayStartupConfiguration(config);\r\n\r\n  ServerFeatures(app);\r\n  // Set-up local proxy for images from cms, and delivery api requests\r\n  // to save doing rewrites and extra code\r\n  ConfigureReverseProxies(app, config.reverseProxyPaths);\r\n  ServeStaticAssets(app, config);\r\n  ConfigureWebApp(app, ReactApp, config);\r\n\r\n  app.on('ready', async () => {\r\n    // Configure DNS to make life easier\r\n    await ConfigureLocalDNS();\r\n\r\n    Loadable.preloadAll().then(() => {\r\n      var server = app.listen(3001, () => {\r\n        console.info(`HTTP server is listening @ port 3001`);\r\n        setTimeout(function() {\r\n          app.emit('app_started');\r\n        }, 500);\r\n      });\r\n      app.on('stop', () => {\r\n        server.close(function() {\r\n          console.info('GoodBye :(');\r\n        });\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nexport default { app, apiProxy, start };\r\n"],"names":["servers","SERVERS","projects","PROJECTS","DisplayStartupConfiguration","config","console","log","JSON","stringify","reverseProxyPaths","fetchMyIp","env","configureLocalEndpoint","response","fetch","method","headers","ipJson","json","ip","startsWith","alias","internalVip","error","apiConfig","DELIVERY_API_CONFIG","localDns","evilDns","add","internalIp","rootUrl","apiProxy","httpProxy","createProxyServer","reverseProxies","app","deliveryApiProxy","all","req","res","target","hostname","indexOf","previewIis","iis","web","changeOrigin","on","e","path","cms","CacheDuration","static","expressStatic","getCacheDuration","status","replaceStaticPath","string","staticFolderPath","replace","bundleManipulationMiddleware","staticRoutePath","maxage","next","filename","basename","modernBundle","endsWith","legacyBundle","jsRuntimeLocation","resolve","jsRuntimeBundle","fs","readFileSync","modifiedBundle","set","type","send","readError","staticAssets","staticRoutePaths","use","map","p","express","ResponseMethod","end","handleResponse","request","content","hashKeys","keys","XXHash","require","returnKeys","forEach","cacheKey","inputBuffer","Buffer","from","toLowerCase","hashed","h32","toString","reversedhex","match","reverse","join","outputBuffer","push","substring","addStandardHeaders","state","packagejson","groups","info","entryDepends","selectEntryDepends","Array","length","nodeDepends","selectNodeDepends","toJS","currentTreeId","selectCurrentTreeID","nodeDependsKeys","nodeKey","allDepends","allDependsHashed","surrogateKeyHeader","name","header","addVarnishAuthenticationHeaders","setHeader","statusCode","message","stateEntry","selectRouteEntry","project","selectCurrentProject","globalGroups","allowedGroups","allGroups","getIn","loadableBundleData","stats","templates","build","bundle","parse","ex","templateHTML","html","templateHTMLStatic","templateHTMLFragment","fragment","webApp","ReactApp","routes","withReducers","withSagas","withEvents","startupScriptFilename","differentialBundles","disableSsrRedux","handleResponses","bundleData","default","legacy","modern","responseHandler","versionInfo","get","url","matchedStaticRoute","matchRoutes","StaticRoutes","isStaticRoute","staticRoute","onlyDynamic","route","ssr","normaliseQs","q","accessMethod","mapJson","query","DYNAMIC","dynamic","REDUX","redux","FRAGMENT","STATIC","value","context","store","createStore","fromJS","history","initialEntries","versionStatusFromHostname","GetDeliveryApiStatusFromHostname","dispatch","setVersionStatus","versionStatus","setVersion","commitRef","buildNo","pickProject","setCurrentProject","modules","jsx","moduleName","ReduxProvider","buildBundleTags","bundles","bundleTags","publicPath","includes","filter","f","fromEntries","Object","entries","lib","paths","renderToString","loadableBundles","getBundles","isDynamicHint","responseHtmlDynamic","runSaga","rootSaga","toPromise","then","sheet","ServerStyleSheet","collectStyles","helmet","Helmet","renderStatic","rewind","htmlAttributes","title","metadata","meta","redirect","reduxState","getState","styleTags","getStyleTags","serialisedReduxData","serialize","responseHTML","minifyCssString","err","catch","stack","close","start","ServerFeatures","disable","ConfigureReverseProxies","ServeStaticAssets","ConfigureWebApp","ConfigureLocalDNS","Loadable","preloadAll","server","listen","setTimeout","emit"],"mappings":"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"}